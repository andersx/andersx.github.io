---
layout: post
title: Fast Lennard-Jones and electrostatics on a CPU
date: '2011-10-26T22:26:00.009+02:00'
author: hellogetmyblogback
tags:
- opls molecular mechanics force field speed fast implementation icpc g++ c++ quake
  fast inverse square root
modified_time: '2011-10-27T09:34:41.500+02:00'
blogger_id: tag:blogger.com,1999:blog-8160351477288734008.post-122881654375705947
blogger_orig_url: https://combichem.blogspot.com/2011/10/fast-lennard-jones-and-electrostatics.html
---

<div style="color: black; text-align: justify;">I recently got interested in programming molecular mechanics force fields on CPUs and GPUs. One of the hurdles you have to get through, is the non bonded interactions, which you have to iterate over all pairs of atoms. It thus scales as N^2 with the number of atoms, whereas the bonded terms scale only linearly. A good example is the <a href="http://en.wikipedia.org/wiki/OPLS">OPLS force field</a> (read more on <a href="http://en.wikipedia.org/wiki/OPLS">Wikipedia</a>). Here the non-bonded interactions are given by a Lennard-Jones potential term an an electrostatic term:</div><div style="color: black; text-align: justify;"><br />
</div><div class="separator" style="clear: both; color: black; text-align: center;"><a href="http://upload.wikimedia.org/wikipedia/en/math/d/4/8/d48008008d016c29d82d4009943a5783.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="49" src="http://upload.wikimedia.org/wikipedia/en/math/d/4/8/d48008008d016c29d82d4009943a5783.png" width="320" /></a></div><div style="color: black; text-align: justify;"></div><div style="color: black; text-align: justify;"></div><div style="color: black; text-align: justify;"></div><div style="color: black; text-align: justify;"></div><div style="color: black; text-align: justify;"><br />
</div><div style="color: black; text-align: justify;">For more information about molecular modeling and force fields, I can&nbsp; recommend reading the <a href="http://www.crcpress.com/product/isbn/9781420075267">Molecular Modeling Basics</a> book, which has excellent pages on the subject. You can also just ask in the comment sections, if you have anything. Finally, the code can be found for download at the bottom of this post.</div><div style="color: black; text-align: justify;"><br />
</div><div style="color: black; text-align: justify;">Now let's get started! I've put the coordinates of all atoms in the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">double coordinates[]</span> 2D array. In the example I'm using the coordinates of the protein structure of Cutinase <a href="http://www.pdb.org/pdb/explore/explore.do?structureId=1cex">1CEX</a>, which has 2867 atoms. I used <a href="http://kryptonite.nbcr.net/pdb2pqr/">pdb2pqr</a> for protonation. I'm going to assume (for simplicity), that all interactions use the same parameters. The naive way to implement the non-bonded OPLS interaction could be (in C/C++):</div><pre style='color:#000000;background:#ffffff;'><span style='color:#696969; '>// Lennard-Jones parameters</span>
<span style='color:#800000; font-weight:bold; '>double</span> A <span style='color:#808030; '>=</span> <span style='color:#008000; '>10.0</span><span style='color:#800080; '>;</span>
<span style='color:#800000; font-weight:bold; '>double</span> C <span style='color:#808030; '>=</span> <span style='color:#008000; '>10.0</span><span style='color:#800080; '>;</span>
<span style='color:#696969; '>// Electrostatic parameter</span>
<span style='color:#800000; font-weight:bold; '>double</span> E <span style='color:#808030; '>=</span> <span style='color:#808030; '>-</span><span style='color:#008000; '>10.0</span><span style='color:#800080; '>;</span>

<span style='color:#800000; font-weight:bold; '>double</span> non_bonded_interaction<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>double</span> a<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>double</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>

     <span style='color:#696969; '>// Fastest way of getting distance</span>
     <span style='color:#800000; font-weight:bold; '>double</span> distance <span style='color:#808030; '>=</span> <span style='color:#603000; '>sqrt</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span>
                          <span style='color:#808030; '>+</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span>
                          <span style='color:#808030; '>+</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

     <span style='color:#800000; font-weight:bold; '>return</span> A<span style='color:#808030; '>*</span><span style='color:#603000; '>pow</span><span style='color:#808030; '>(</span>distance<span style='color:#808030; '>,</span> <span style='color:#808030; '>-</span><span style='color:#008000; '>12.0</span><span style='color:#808030; '>)</span> 
          <span style='color:#808030; '>+</span> C<span style='color:#808030; '>*</span><span style='color:#603000; '>pow</span><span style='color:#808030; '>(</span>distance<span style='color:#808030; '>,</span> <span style='color:#808030; '>-</span><span style='color:#008000; '>6.0</span><span style='color:#808030; '>)</span>
          <span style='color:#808030; '>+</span> E<span style='color:#808030; '>/</span>distance<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>

<span style='color:#800000; font-weight:bold; '>int</span> <span style='color:#400000; '>main</span><span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>

     <span style='color:#696969; '>// Set energy to 0</span>
     <span style='color:#800000; font-weight:bold; '>double</span> energy <span style='color:#808030; '>=</span> <span style='color:#008000; '>0.0</span><span style='color:#800080; '>;</span>
     <span style='color:#696969; '>// Loop over all atoms</span>
     <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>int</span> i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> i <span style='color:#808030; '>&lt;</span> n_atoms<span style='color:#800080; '>;</span> i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>

          <span style='color:#696969; '>// Only up to i-1, to avoid double counting </span>
          <span style='color:#696969; '>// interactions, and self-interactions</span>
          <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>int</span> j <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> j <span style='color:#808030; '>&lt;</span> i<span style='color:#800080; '>;</span> j<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>

               energy <span style='color:#808030; '>+</span><span style='color:#808030; '>=</span> non_bonded_interaction<span style='color:#808030; '>(</span>coordinates<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>
                                                coordinates<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

          <span style='color:#800080; '>}</span>
     <span style='color:#800080; '>}</span>
     <span style='color:#666616; '>std</span><span style='color:#800080; '>::</span><span style='color:#603000; '>cout</span> <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span> <span style='color:#800000; '>"</span><span style='color:#0000e6; '>E = </span><span style='color:#800000; '>"</span> <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span> energy <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>&lt;</span> <span style='color:#666616; '>std</span><span style='color:#800080; '>::</span>endl

     <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 <span style='color:#800080; '>}</span>
</pre><div style="color: black; text-align: justify;">Timing this gives 0.0300 µs per iteration with the Intel <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">icpc</span> compiler, and 0.189 µs with the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">g++</span> compiler, both with <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">-O3</span> optimization.&nbsp;</div><div style="color: black; text-align: justify;">As I will demonstrate, this is because <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">pow()</span> is horribly implemented in <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">g++</span>. Lets further optimize the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">non_bonded_interaction() <span style="font-family: inherit;">function</span>:</span></div><pre style='color:#000000;background:#ffffff;'><span style='color:#800000; font-weight:bold; '>double</span> non_bonded_interaction<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>double</span> a<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>double</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>

     <span style='color:#800000; font-weight:bold; '>double</span> distance <span style='color:#808030; '>=</span> <span style='color:#603000; '>sqrt</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span>
                          <span style='color:#808030; '>+</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span>
                          <span style='color:#808030; '>+</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

     <span style='color:#800000; font-weight:bold; '>double</span> distance6 <span style='color:#808030; '>=</span> distance <span style='color:#808030; '>*</span> distance <span style='color:#808030; '>*</span> distance
                      <span style='color:#808030; '>*</span> distance <span style='color:#808030; '>*</span> distance <span style='color:#808030; '>*</span> distance<span style='color:#800080; '>;</span>
     <span style='color:#800000; font-weight:bold; '>double</span> distance12 <span style='color:#808030; '>=</span> distance6 <span style='color:#808030; '>*</span> distance6<span style='color:#800080; '>;</span>

     <span style='color:#800000; font-weight:bold; '>return</span> A<span style='color:#808030; '>/</span>distance12 <span style='color:#808030; '>+</span> C<span style='color:#808030; '>/</span>distance6 <span style='color:#808030; '>+</span> E<span style='color:#808030; '>/</span>distance<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
</pre><div style="color: black;"><br />
</div><div style="color: black; text-align: justify;">Now we get: 0.0295 µs with <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">icpc</span> and 0.0313 µs with <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">g++</span>. Clearly <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">pow()</span> shouldn't be used with GNU compilers!</div><div style="color: black; text-align: justify;"><br />
</div><div style="color: black; text-align: justify;">Next on our list of optimizations is getting rid of divisions. Divisions are performed iteratively by the CPU, while multiplications are done bit-parallel by specialized circuits hard-coded into the CPU silicon. We have three divisions, but we can write everything in terms of only one, using reciprocal distances:</div><div style="color: black;"><br />
</div><pre style='color:#000000;background:#ffffff;'><span style='color:#800000; font-weight:bold; '>double</span> non_bonded_interaction<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>double</span> a<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>double</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>

     <span style='color:#800000; font-weight:bold; '>double</span> distance <span style='color:#808030; '>=</span> <span style='color:#603000; '>sqrt</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span>
                          <span style='color:#808030; '>+</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span>
                          <span style='color:#808030; '>+</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

     <span style='color:#800000; font-weight:bold; '>double</span> inv_distance <span style='color:#808030; '>=</span> <span style='color:#008000; '>1.0</span><span style='color:#808030; '>/</span>distance<span style='color:#800080; '>;</span>
     <span style='color:#800000; font-weight:bold; '>double</span> inv_distance6 <span style='color:#808030; '>=</span> inv_distance <span style='color:#808030; '>*</span> inv_distance
                          <span style='color:#808030; '>*</span> inv_distance <span style='color:#808030; '>*</span> inv_distance
                          <span style='color:#808030; '>*</span> inv_distance <span style='color:#808030; '>*</span> inv_distance<span style='color:#800080; '>;</span>
     <span style='color:#800000; font-weight:bold; '>double</span> inv_distance12 <span style='color:#808030; '>=</span> inv_distance6 <span style='color:#808030; '>*</span> inv_distance6<span style='color:#800080; '>;</span>

     <span style='color:#800000; font-weight:bold; '>return</span> A <span style='color:#808030; '>*</span> inv_distance12 
          <span style='color:#808030; '>+</span> C <span style='color:#808030; '>*</span> inv_distance6 
          <span style='color:#808030; '>+</span> E <span style='color:#808030; '>*</span> inv_distance<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
</pre><br />
<br />
<div style="color: black; text-align: justify;">This gives us 0.0173 µs with <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">icpc</span> and 0.0189 µs with <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">g++</span>. Still ... there is one division left and also a square-root which is problematic. These are what takes up by far the most time in the calculation. But there is a hacky trick we can use. I'm going to show you how to use an approach by Newton to estimate inverse square roots .. take a look at <a href="http://en.wikipedia.org/wiki/Fast_inverse_square_root">this Wikipedia page</a> for more info. The method became famous after it was found in the Quake III open source engine. Here it is in double type, so slightly different than the float type example on wikipedia. I'm using two final iterations to achieve sufficient accuracy.</div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><br />
</div><pre style='color:#000000;background:#ffffff;'><span style='color:#800000; font-weight:bold; '>inline</span> <span style='color:#800000; font-weight:bold; '>double</span> fast_inv_sqrt<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>double</span> number<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>

        <span style='color:#800000; font-weight:bold; '>long</span> <span style='color:#800000; font-weight:bold; '>long</span> i<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>double</span> x2<span style='color:#808030; '>,</span> y<span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>double</span> threehalfs <span style='color:#808030; '>=</span> <span style='color:#008000; '>1.5</span><span style='color:#800080; '>;</span>
        x2 <span style='color:#808030; '>=</span> number <span style='color:#808030; '>*</span> <span style='color:#008000; '>0.5</span><span style='color:#800080; '>;</span>
        y  <span style='color:#808030; '>=</span> number<span style='color:#800080; '>;</span>
        i  <span style='color:#808030; '>=</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span> <span style='color:#800000; font-weight:bold; '>long</span> <span style='color:#800000; font-weight:bold; '>long</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span>y<span style='color:#800080; '>;</span>
        i  <span style='color:#808030; '>=</span> <span style='color:#008000; '>0x5fe6ec85e7de30da</span> <span style='color:#808030; '>-</span> <span style='color:#808030; '>(</span> i <span style='color:#808030; '>></span><span style='color:#808030; '>></span> <span style='color:#008c00; '>1</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        y  <span style='color:#808030; '>=</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span> <span style='color:#800000; font-weight:bold; '>double</span> <span style='color:#808030; '>*</span> <span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span>i<span style='color:#800080; '>;</span>
        y  <span style='color:#808030; '>=</span> y <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span> threehalfs <span style='color:#808030; '>-</span> <span style='color:#808030; '>(</span> x2 <span style='color:#808030; '>*</span> y <span style='color:#808030; '>*</span> y <span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        y  <span style='color:#808030; '>=</span> y <span style='color:#808030; '>*</span> <span style='color:#808030; '>(</span> threehalfs <span style='color:#808030; '>-</span> <span style='color:#808030; '>(</span> x2 <span style='color:#808030; '>*</span> y <span style='color:#808030; '>*</span> y <span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        <span style='color:#800000; font-weight:bold; '>return</span> y<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
</pre><div style="color: black; text-align: justify;">Using this, we can avoid ever dividing and taking square roots, and reduce our code to:</div><div style="color: black;"><br />
</div><pre style='color:#000000;background:#ffffff;'><span style='color:#800000; font-weight:bold; '>double</span> non_bonded_interaction<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>double</span> a<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>const</span> <span style='color:#800000; font-weight:bold; '>double</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
     <span style='color:#800000; font-weight:bold; '>double</span> dx <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
     <span style='color:#800000; font-weight:bold; '>double</span> dy <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
     <span style='color:#800000; font-weight:bold; '>double</span> dz <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>a<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>-</span> b<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
     <span style='color:#800000; font-weight:bold; '>double</span> distance_sqr <span style='color:#808030; '>=</span> dx<span style='color:#808030; '>*</span>dx <span style='color:#808030; '>+</span> dy<span style='color:#808030; '>*</span>dy <span style='color:#808030; '>+</span> dz<span style='color:#808030; '>*</span>dz<span style='color:#800080; '>;</span>

     <span style='color:#800000; font-weight:bold; '>double</span> inv_distance   <span style='color:#808030; '>=</span> fast_inv_sqrt<span style='color:#808030; '>(</span>distance_sqr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
     <span style='color:#800000; font-weight:bold; '>double</span> inv2_distance  <span style='color:#808030; '>=</span> inv_distance <span style='color:#808030; '>*</span> inv_distance<span style='color:#800080; '>;</span>
     <span style='color:#800000; font-weight:bold; '>double</span> inv6_distance  <span style='color:#808030; '>=</span> inv2_distance <span style='color:#808030; '>*</span> inv2_distance
                           <span style='color:#808030; '>*</span> inv2_distance<span style='color:#800080; '>;</span>
     <span style='color:#800000; font-weight:bold; '>double</span> inv12_distance <span style='color:#808030; '>=</span> inv6_distance <span style='color:#808030; '>*</span> inv6_distance<span style='color:#800080; '>;</span> 
     <span style='color:#800000; font-weight:bold; '>return</span> A <span style='color:#808030; '>*</span> inv_distance12 
          <span style='color:#808030; '>+</span> C <span style='color:#808030; '>*</span> inv_distance6 
          <span style='color:#808030; '>+</span> E <span style='color:#808030; '>*</span> inv_distance<span style='color:#800080; '>;</span>


<span style='color:#800080; '>}</span>
</pre><div style="color: black;"><br />
</div><div style="color: black; text-align: justify;">Now, timings are down to 0.0118 µs for <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">icpc</span> and 0.0155 µs for<span style="font-family: &quot;Courier New&quot;,Courier,monospace;"> g++</span> per iteration. It's hard to optimize the code further from here, using code that isn't very hacky, but we still got a x2.5 times speed-up with the Intel compiler and x12.2! times speed-up with the GNU C++ compiler. Still, we can always try and parallelize the code using OpenMP. This is the easiest way to parallelize code there ever was. We only need to add ONE compiler flag, which tells it to parallelize the next loop. Take a look:</div><div style="color: black;"><br />
</div><pre style='color:#000000;background:#ffffff;'><span style='color:#696969; '>// Loop over all atoms</span>
     <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>int</span> i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> i <span style='color:#808030; '>&lt;</span> n_atoms<span style='color:#800080; '>;</span> i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>

<span style='color:#696969; '>// Tell compiler, to run next in loop in parallel</span>
<span style='color:#004a43; '>#</span><span style='color:#004a43; font-weight:bold; '>pragma </span><span style='color:#bb7977; font-weight:bold; '>omp parallel for reduction(+:energy)</span>

          <span style='color:#696969; '>//Only up to i-1, to avoid double counting interactions, and self-interactions</span>
          <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>unsigned</span> <span style='color:#800000; font-weight:bold; '>int</span> j <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> j <span style='color:#808030; '>&lt;</span> i<span style='color:#800080; '>;</span> j<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>

               energy <span style='color:#808030; '>+</span><span style='color:#808030; '>=</span> non_bonded_interaction<span style='color:#808030; '>(</span>coordinates<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> coordinates<span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

          <span style='color:#800080; '>}</span>
     <span style='color:#800080; '>}</span>
</pre><div style="color: black;"><br />
To compile we also must remember to link to OpenMP:<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">icpc </span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">-O3 </span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">cpuff.cpp -o cpuff -openmp </span>(for Intel)<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">g++ -O3 cpuff.cpp -o cpuff -fopenmp </span>(for GNU)<br />
<br />
</div><div style="color: black; text-align: justify;">On four cores instead of one, this gives us: 0.0042 µs for <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">icpc</span> and 0.0042 for <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">g++</span> as well. That's a x2.8 and x3.6 speed up for Intel and GNU, respectively! Not too shabby, by no means! Compared to the unparallelized code, this is a x7.1 speed-up for Intel and a whooping x45.0 speed-up for the initial lazy GNU compiled code.</div><div style="color: black; text-align: justify;"><br />
</div><div style="color: black; text-align: justify;">I hope this post will inspire you to play around with these easy-to-do optimizations yourself. You can download code examples here:<br />
<br />
<a href="http://dl.dropbox.com/u/17435887/cpuff.cpp">cpuff.cpp</a> (the implementation)</div><div style="color: black; text-align: justify;"></div><div style="color: black; text-align: justify;"><a href="http://dl.dropbox.com/u/17435887/coordinates.h">coordinates.h</a> (the protein coordinates. I put this in a 2D array to avoid writing a parser)<br />
<br />
<br />
</div><div style="color: black; text-align: justify;">DISCLAIMER: The above was carried out on an Intel Core i5-760 running 64-bit Ubuntu Server 10.04.3, icpc (ICC) 12.0.0 20101006 and g++ (Ubuntu 4.4.3-4ubuntu5) 4.4.3. Timings are averages over 10 consecutive runs. I compiled everything with <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">-O3 </span>optimization.</div><div style="color: black;"><br />
</div><br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span>