---
layout: post
title: Compiling GAMESS with CUDA (GPU support)
date: '2011-02-11T15:31:00.003+01:00'
author: hellogetmyblogback
tags:
modified_time: '2011-02-13T00:03:44.656+01:00'
blogger_id: tag:blogger.com,1999:blog-8160351477288734008.post-1998651932187766778
blogger_orig_url: https://combichem.blogspot.com/2011/02/compiling-gamess-with-cuda-gpu-support.html
---

<div style="color: black;">As I mentioned in a previous post, much of the mathematics involved in quantum, chemistry can be formulated to be massively parallelized and implementation exists so you can run most types of calculations on hundreds or thousands of cores. I've heard people from Pacific Northwest National Laboratory running parallel coupled cluster CCSD calculations on 225,000 processors at 1.3 PFlops!</div><div style="color: black;"><br />
</div><div style="color: black;">Very few people have access to hundreds or thousands of individual CPU cores at home or work, but most of us have access to hundreds of <i>cores</i> on the GPU that drives the computer graphics. So let's use our GPUs for massively parallel quantum computing, dawg!</div><div class="separator" style="clear: both; color: black; text-align: center;"><a href="http://images.nvidia.com/products/geforce-gtx-560ti/geforce-gtx-560ti-top-med.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://images.nvidia.com/products/geforce-gtx-560ti/geforce-gtx-560ti-top-med.png" /></a></div><div style="color: black;"><br />
</div><div style="color: black;">This post tells you how to compile the newest GAMESS (Oct 10, 2010, R1) so it runs RHF 2-electron integrals using an NVIDIA GPU. </div><div style="color: black;">I will follow up with a post on the theory behind the GPU parallel 2-el integral routines and a post on GAMESS/GPU benchmark. I've used a lot of the pointers in the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">gamess/libqc/aaa.readme.1st </span>file. Let me know if you found this helpful.</div><div style="color: black;"><br />
</div><div style="color: black;">In order to do compile GAMESS with CUDA support (using this guide), there are a few requirements:</div><div style="color: black;"><br />
</div><ul style="color: black;"><li>I am going assume 64-bit Linux, because I only tried this on that platfrom. </li>
<li>You need a copy of GAMESS from at least Oct 10, 2010. I'm further more going to assume that you already have properly installed said version of GAMESS and that your installation works. I'm assuming it's installed in&nbsp; <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">~/gamess</span></li>
<li>You need a NVIDIA graphics card which is CUDA enable (all newer NVIDIA cards are) with a working set of drivers.</li>
<li>The GNU gcc and g++ compilers. I've only been able to make this work with 4.1 and 4.3, however. These are included the repositories of all major Linux releases. Other versions may work, but these are "guarateed" to work. Guaranteed, as in they potentially may compile the code. Get these via "<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">sudo apt-get install gcc-4.3 g++-4.3</span>", "<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">yum install</span>", etc. or the ditto of your distro.</li>
<li>CUDA Toolkit version 2.3. You can download it <a href="http://developer.nvidia.com/object/cuda_2_3_downloads.html#Linux">here</a>. GAMESS does not work with the current version (which is 3.2, at the time of writing. Get the version that matches your Linux the most. I used the Ubuntu 9.10 version on a Ubuntu 10.04 LTS system and the RedHat Enterprise Linux 5.3 version on a CentOS 5.4 system - both worked just fine!</li>
<li>A compiled and version of Boost 1.43. I tried some other versions, but they didn't work. 1.43 is "guaranteed" to work.</li>
<li>You need an auxiliary code preprocessor named "cheetah" to do stuff to the C++ source code. I used the newest of 2.4.4. </li>
</ul><div style="color: black;"><br />
</div><div style="color: black;">I can't really help you with installing the NVIDIA drivers, but there are many guides floating around on the interwebs. It is likely that the one that came with your Linux works, but it may not. In that case, get a newer driver. The method to do this is highly OS dependent. Unfortunately, you can't use the open source nouveau nv driver - you need to run the real (and closed) McCoy from NVIDIA.</div><div style="color: black;"><br />
</div><div style="color: black;">UPDATE: I suggest running the newest beta driver from NVIDIA, since it includes some CUDA specific improvements:</div><div style="color: black;"><br />
</div><pre style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">wget http://us.download.nvidia.com/XFree86/Linux-x86_64/270.18/NVIDIA-Linux-x86_64-270.18.run</span></pre><div style="color: black;"><br />
</div><div style="color: black;"><b>Step 1)</b> Installing and modifying Boost 1.43 from the source. First make a temporary directory and get Boost:</div><pre style="color: black;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;"></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;">mkdir ~/temp</span>
<span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;">cd temp</span>
<span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;">wget http://downloads.sourceforge.net/project/boost/boost/1.43.0/boost_1_43_0.tar.bz2</span>
<span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;">tar xjf bo</span><span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;">ost_1_43_0.tar.bz2</span>
<span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;">cd boost_1_</span><span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;">43_0/</span><ul></ul></pre><div style="color: black;">Now, compile and install Boost. I always use <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">~/programs/</span> for my installation. Boost uses it's own configure and make scripts, and takes about 5-10 minutes to compile on my machine.</div><pre style="color: black;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;">./bootstrap.sh --prefix=/home/andersx/programs/boost_1_43_0</span>
<span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;">./bjam</span>
<span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;">./bjam install </span>
<ul></ul></pre><div style="color: black;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">nvcc</span> (the CUDA compiler) requires three minor modifications of the Boost header files, in order to compile code linked to Boost.</div><div style="color: black;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span></div><div style="color: black;"><b>Step 1.1)</b> Change <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">/home/andersx/programs/boost_1_43_0</span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">/include/boost/mpl/aux_/integral_wrapper.hpp</span> line 59 from: </div><pre style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#if BOOST_WORKAROUND(__EDG_VERSION__, &lt;= 243)</span></pre><div style="color: black;">to</div><pre style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#if BOOST_WORKAROUND(__EDG_VERSION__, &lt;= 243) || defined(__CUDACC__)</span></pre><div style="color: black;"><b>Step 1.2)</b> Change <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">/home/andersx/programs/boost_1_43_0</span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">/include/boost/mpl/size_t_fwd.hpp</span> around line 22, so that one original line is in an 'else' clause: </div><pre style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#if defined(__CUDACC__)
&nbsp;&nbsp; typedef std::size_t std_size_t;
&nbsp;&nbsp; template&lt; std_size_t N &gt; struct size_t;
#else
&nbsp;&nbsp; template&lt; std::size_t N &gt; struct size_t;
#endif</span></pre><div style="color: black;"><b>Step 1.3) </b>Change <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">/home/andersx/programs/boost_1_43_0</span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">/include/boost/mpl/size_t.hpp</span>&nbsp; around line 23, so that four original lines are in an else clause:</div><div style="color: black;"><br />
</div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#if defined(__CUDACC__)</span><br />
<span style="font-size: x-small;">&nbsp; #define AUX_WRAPPER_VALUE_TYPE std_size_t &nbsp;</span><br />
<span style="font-size: x-small;">&nbsp; #define AUX_WRAPPER_NAME size_t &nbsp;&nbsp;&nbsp;</span><br />
<span style="font-size: x-small;">&nbsp; #define AUX_WRAPPER_PARAMS(N) std_size_t N&nbsp;</span><br />
<span style="font-size: x-small;">#else &nbsp;</span><br />
<span style="font-size: x-small;">&nbsp; //typedef std::size_t std_size_t; &nbsp;&nbsp;&nbsp;</span><br />
<span style="font-size: x-small;">&nbsp; #define AUX_WRAPPER_VALUE_TYPE std::size_t &nbsp;&nbsp;&nbsp;</span><br />
<span style="font-size: x-small;">&nbsp; #define AUX_WRAPPER_NAME size_t &nbsp;&nbsp;&nbsp;</span><br />
<span style="font-size: x-small;">&nbsp; #define AUX_WRAPPER_PARAMS(N) std::size_t N&nbsp;</span><br />
<span style="font-size: x-small;">#endif</span></div><div style="color: black;"><br />
</div><div style="color: black;"><b>Step 2)</b> Download and install Cheetah. This is pretty much straight forward:</div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><br />
<span style="font-size: x-small;">cd ~/temp</span></div><pre style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">wget http://pypi.python.org/packages/source/C/Cheetah/Cheetah-2.4.4.tar.gz</span></pre><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">tar xvf Cheetah-2.4.4.tar.gz</span></div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">cd Cheetah-2.4.4/</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /> python setup.py install</span></div><div style="color: black;"><br />
</div><div style="color: black;"><b>Step 3)</b> Get the CUDA Toolkit v. 2.3:</div><div style="color: black;"><br />
</div><div style="color: black;">You can follow  <a href="http://developer.nvidia.com/object/cuda_2_3_downloads.html#Linux">this</a> link and get the version which matches your Linux the closest. I used the Ubuntu 9.10 version on a Ubuntu 10.04.2. </div><pre style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">cd ~/temp</span><span style="font-size: x-small;">&nbsp;</span></pre><pre style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">wget http://developer.download.nvidia.com/compute/cuda/2_3/toolkit/cudatoolkit_2.3_linux_64_ubuntu9.04.run</span></pre><pre style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"></span></pre><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">sh ./cudatoolkit_2.3_linux_64_ubuntu9.04.run</span></div><div style="color: black;"><br />
</div><div style="color: black;">This installs the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">nvcc</span> compiler. I used the default path which is <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">/usr/local</span> - you may of course put <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">nvcc</span> wherever you want. This can be useful, if you want the newest <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">nvcc</span> for another program and have different versions installed simultaneously.</div><div style="color: black;"><br />
</div><div style="color: black;">You then need to add the following lines to your <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">~/.bashrc</span> file in order to always be able to find the CUDA compiler and libraries:</div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><br />
</div><pre><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">export PATH=/usr/local/cuda/bin:$PATH</span></div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH</span></div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="color: black;"></div></pre>then write<br />
<div style="color: black;"><br />
</div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">source ~/.bashrc</span></div><div style="color: black;"><br />
</div><div style="color: black;">or log out and back in to set the environment variables properly.</div><div style="color: black;"><br />
</div><div style="color: black;"><b>Step 4) </b>You are now ready to compile the GPU Fock routines (called libqc). These are located in the libqc directory in the GAMESS directory. You may need to add a <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">--mtune=native</span> option. I found it needed with gcc-4.3, but using the option didn't work with gcc-4.1, YMMV. "<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">native</span>" tells your compiler to optimize the code for the local machine at compilation time.</div><div style="color: black;">&nbsp; </div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">cd ~/gamess/libqc</span></div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="color: black;"><br />
if you use gcc-4.3 and g++-4.3:</div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">CC=gcc-4.3 CXX=g++-4.3 CXXFLAGS='-O2 -DNDEBUG -msse3 -ffast-math -ftree-vectorize -mtune=native' ./configure --with-gamess --with-integer8 --with-boost=/home/andersx/programs/boost_1_43_0 --prefix=/home/andersx/gamess/libqc</span></div><div style="color: black;"><br />
</div><div style="color: black;">if you use gcc-4.1 and g++-4.1:</div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">CC=gcc-4.1 CXX=g++-4.1 CXXFLAGS='-O2 -DNDEBUG -msse3 -ffast-math -ftree-vectorize' ./configure --with-gamess --with-integer8 --with-boost=/home/andersx/programs/boost_1_43_0 --prefix=/home/andersx/gamess/libqc</span></div><div style="color: black;"><br />
</div><div style="color: black;">If the configure script ran without problems, you're now ready to compile libqc:</div><div style="color: black;"><span style="font-size: x-small;"> </span></div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><br />
<span style="font-size: x-small;">make</span></div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">make install</span></div><div style="color: black;"><br />
</div><div style="color: black;">This took my PC around 20 minutes. I thought it had crashed, but there was one file which just took 15 minutes to compile. Last thing to do in this step is making libqc visible to your compiler and GAMESS. Add the following line to <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">~/.bashrc</span> and source it as in step 3.</div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><br />
<span style="font-size: x-small;">export LD_LIBRARY_PATH=/home/andersx/gamess/libqc:$LD_LIBRARY_PATH</span></div><div style="color: black;"><br />
</div><div style="color: black;"><b>Step 5)</b> Linking GAMESS to libqc:</div><div style="color: black;"><br />
</div><div style="color: black;">In the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">~/gamess/comp</span> file, you need to set this flag to true:</div><div style="color: black;"><br />
</div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">GPUCODE=true&nbsp;</span></div><div style="color: black;"><br />
</div><div style="color: black;">Now, recompile the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">rhfuhf</span> GAMESS routine with libqc:</div><div style="color: black;"><br />
</div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">./comp rhfuhf</span></div><div style="color: black;"><br />
</div><div style="color: black;">Finally, in the GAMESS linking script (<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">~/gamess/lked</span>) you need to link to libqc properly. Set the following flag to true: </div><div style="color: black;"><br />
</div><div style="color: black;"><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">GPUCODE=true</span></span></div><div style="color: black;"><br />
</div><div style="color: black;">Then change the library pathnames at the second place the string '<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">GPUCODE</span>' appears. The three paths must point to your libqc, CUDA, and Boost libraries.</div><div style="color: black;"><br />
</div><div style="color: black;"><br />
</div><div style="color: black;">Finally, you need to link a new executable. Type the following:</div><div style="color: black;"><br />
</div><div style="color: black; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">./lked gamess gpu</span>&nbsp;</div><div style="color: black;"><br />
</div><div style="color: black;">If linking was successful, there is now an executable named <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">gamess.gpu.x</span>.</div><div style="color: black;"><br />
</div><div style="color: black;">Congratulations: You're now able to do 2-el integrals and Fock-matrix formation GPU parallel.</div>